<html>
<head>
<link rel="stylesheet" href="./style.css">


<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js" type="text/javascript"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>




<script>

  const pix_per_stud = 2;
  const catalog = [ 
  
     { "id" : "2867.8", "img" : "Track/2867.8.gif", "rotate_cw_step" : "22.5"  },   
     { "id" : "2865.8", "img" : "Track/2865.8.gif", "rotate_cw_step" : "22.5" },
     { "id" : "2859.8", "img" : "Track/2859.8.gif", "rotate_cw_step" : "22.5"   },
     { "id" : "2859halfcurve.8", "img" : "Track/2859halfcurve.8.gif", "rotate_cw_step" : "22.5"  },
     { "id" : "2861.8", "img" : "Track/2861.8.gif", "rotate_cw_step" : "22.5"  },
	 { "id" : "2861halfcurve.8", "img" : "Track/2861halfcurve.8.gif", "rotate_cw_step" : "22.5"  },
	 { "id" : "607p01.7", "img" : "Road/607p01.7.gif", "rotate_cw_step" : "90"  },
	 { "id" : "608p01.7", "img" : "Road/608p01.7.gif", "rotate_cw_step" : "90"  },
	 { "id" : "606p02.7", "img" : "Road/606p02.7.gif", "rotate_cw_step" : "90"  },
	 { "id" : "609p01.7", "img" : "Road/609p01.7.gif", "rotate_cw_step" : "90"  }
	 
	 
  ];
  
  
  var current_element=null;
  
  // rotate clockwise
  function rotateCW(){
    if (current_element==null){
	  alert("Select an item on the grid first.");
	  return
	}
  
    var rotate_cw_step = current_element.getElementsByTagName('img')[0].getAttribute("rotate_cw_step");
    //current_element.getElementsByTagName('img')[0].style.transform = "rotate("+rotate_cw_step+"deg) translate(0px,5px)";
	current_element.getElementsByTagName('img')[0].style.transform = "rotate("+rotate_cw_step+"deg)";
    //$("#" + current_element.id + " img").first().css('transform',"rotate(22.5deg) translate(-10px,57px) ");
    //current_element.style.transform = "rotate(22.5deg) translate(-10px,57px) ";
  
  }
  
  function updateDebugDiv(text){
    $("#debug_div").text(text);
  }
  
  /**
   * Gets computed translate values
   * @param {HTMLElement} element
   * @returns {Object}
   *   https://sagarpansuriya.wordpress.com/2020/08/08/how-to-get-css-translate-values-with-javascript/
   */
  function getTranslateValues (element) {

    const style = window.getComputedStyle(element)
    const matrix = style.transform || style.webkitTransform || style.mozTransform

    // No transform property. Simply return 0 values.
    if (matrix === 'none') {
      return {
      x: 0,
      y: 0,
      z: 0
    }
  }

  // Can either be 2d or 3d transform
  const matrixType = matrix.includes('3d') ? '3d' : '2d'
  const matrixValues = matrix.match(/matrix.*\((.+)\)/)[1].split(', ')

  // 2d matrices have 6 values
  // Last 2 values are X and Y.
  // 2d matrices does not have Z value.
  if (matrixType === '2d') {
    return {
      x: matrixValues[4],
      y: matrixValues[5],
      z: 0
    }
  }

  // 3d matrices have 16 values
  // The 13th, 14th, and 15th values are X, Y, and Z
  if (matrixType === '3d') {
    return {
      x: matrixValues[12],
      y: matrixValues[13],
      z: matrixValues[14]
    }
  }
}  


  function addItemFromCatalog(element){
    var ts = new Date().getTime() / 1000;
   
	var newid=element.id+'_'+ts;
	
	// TODO : build objet from document 
	var rotate_cw_step = element.getAttribute("rotate_cw_step");
	
    var new_item_jq=$('<div class="myItem" onclick="setCurrent(this);" id="'+newid+'"><img style="width:100%" rotate_cw_step="'+rotate_cw_step+'" src="'+element.src+'" /></div>');
	$('#mainContainer').append(new_item_jq);  
	
	// get new_item because jquery new_item_jq is not a dom object.
	new_item = document.getElementById(newid);
	new_item.addEventListener('mousedown', mouseDown, false);
	
	//get original width
	var naturalwidth = new_item.getElementsByTagName('img')[0].naturalWidth;
    new_item.getElementsByTagName('img')[0].setAttribute("o_width",naturalwidth);
	
	//Set width and proportions based on pix_per_stud variable to scale.
	$(new_item.getElementsByTagName('img')[0]).css('width', naturalwidth/pix_per_stud );
	setCurrent(new_item);
	
	
	
	
	
  }
  
  function remove(){
      if (current_element==null){
	  alert("Select an item on the grid first.");
	  
	}else{
	  document.getElementById("mainContainer").removeChild(current_element);
	  current_element=null;
	}
	
  }
  
  function setCurrent(element){
  
    if (element==current_element)
	{
	  current_element=null;
	  setDeselected(element);
	  return;
	}
	
    if (current_element!=null)
	  setDeselected(current_element);
	

	current_element = element;

	setSelected(element);
  }

  function setSelected(element){
    element.style.border="1px solid red";
	element.style.margin="0px 0px 0px 0px";
  }
  
  function setDeselected(element){
	element.style.margin="1px 1px 1px 1px";
    element.style.border="0px";
  }
  
  
  
  
/* codepen.io/netgfx/pen/DEKXBV */
$(document).ready(function(){
  
 
  
  addListeners();
  
  
  var keys = Object.keys(catalog);
  for(let x = 0; x < keys.length; x++){
    //alert(catalog[keys[x]].id);
	
//	alert('<img rotate_cw_step="' + catalog[keys[x]].rotate_cw_step +'" src="./' + catalog[keys[x]].img +'" id="' + catalog[keys[x]].id +'" onclick="addItemFromCatalog(this);" style=""/>');
    var new_catalog_item=$('<img rotate_cw_step="' + catalog[keys[x]].rotate_cw_step +'" src="./' + catalog[keys[x]].img +'" id="' + catalog[keys[x]].id +'" onclick="addItemFromCatalog(this);" style=""/>');
	$('#catalog').append(new_catalog_item);  
    
  }
  
  createGrid();
  
  
});


function addListeners(){
    //document.getElementById('myBox').addEventListener('mousedown', mouseDown, false);
    window.addEventListener('mouseup', mouseUp, false);
}

function mouseUp()
{
    window.removeEventListener('mousemove', divMove, true);
}

function mouseDown(e){
  window.addEventListener('mousemove', divMove, true);
}

var cellSpacing = 1;

function divMove(event) {
    event = event || window.event;
    canvasOffset = $("#mainContainer").offset();
	
	updateDebugDiv("DIV ID="+ current_element.id+" OFFSET LEFT=" + canvasOffset.left + "   TOP=" + canvasOffset.top + "<br>" + "MOUSE Y=" + mouseCoordinate(event, "Y") + " X=" +mouseCoordinate(event, "X") );
    
	// NOTE GC : added 0* because if we have dom elements BEFORE the grid, removing the offset.top will misplace the
	// TOP coord of the selected box because it will start from the beginning of the page, do not count the item before the grid
	//$("#myBox").css({
    //    top: Math.round((mouseCoordinate(event, "Y") - 0*canvasOffset.top) / cellSpacing) * cellSpacing + "px",
    //    left: Math.round((mouseCoordinate(event, "X") - canvasOffset.left) / cellSpacing) * cellSpacing + "px"
    //});
	//alert($("#" + current_element.id).innerHTML);
	//var current_ = document.getElementById(current_element.id);
	//alert(current_id.style.top=100;
	current_element.style.top=Math.round((mouseCoordinate(event, "Y") - 0*canvasOffset.top) / cellSpacing) * cellSpacing + "px";
	current_element.style.left=Math.round((mouseCoordinate(event, "X") - canvasOffset.left) / cellSpacing) * cellSpacing + "px";
	//$("#" + current_element.id).css({
    //    top: Math.round((mouseCoordinate(event, "Y") - 0*canvasOffset.top) / cellSpacing) * cellSpacing + "px",
    //    left: Math.round((mouseCoordinate(event, "X") - canvasOffset.left) / cellSpacing) * cellSpacing + "px"
    //});
	
	
}

// Returns the one half of the current mouse coordinates relative to the browser window.
// Assumes the axis parameter to be uppercase: Either "X" or "Y".
function mouseCoordinate(event, axis) {
    var property = (axis == "X") ? "scrollLeft" : "scrollTop";
    if (event.pageX) {
        return event["page"+axis];
    } else {
        return event["client"+axis] + (document.documentElement[property] ? document.documentElement[property] : document.body[property]);;
    }
};


function createGrid(){
  var counter
  canvasOffset = $("#mainContainer").offset();
  for(var i=1;i<20;i++){
    counter = i*40;
    $("#mainContainer").prepend("<div class='hline' id='hline"+i+"'></div>");
   
    $("#hline"+i).css('top', counter + canvasOffset.top );
  
  }
  
  for(var j=1;j<30;j++){
     counter = j*40;
    $("#mainContainer").prepend("<div class='vline' id='vline"+j+"'></div>");
    $("#vline"+j).css('left',counter+canvasOffset.left);

  }
  
}

/* fine codepen */

  
  
</script>
</head>
<body>


<!--
   <img src="2867.8.gif" onclick="setCurrent(this);" style="border: 1px solid"/>
   <img id="img2" onclick="setCurrent(this);" src="2867.8.gif" style="display:inline; border: 1px solid green"/>
-->
Select a part
<div class="catalog" id="catalog" style="border:0px" >
 
</div>
Action
<div class="transfor_menu">
  <button id="rotateCW" onclick="rotateCW()">Rotate CW</button>
  <button id="remove" onclick="remove()">Remove</button>
</div>




Debug:<div id="debug_div"></div>
<br/>
<div id="mainContainer">
  <!-- <div id="myBox"></div>-->
  
</div>   

</body>
</html>